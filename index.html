<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <title>LAN内の Raspberry Pi を検出</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f1720;
      --card: #0b1220;
      --muted: #9aa6b2;
      --accent: #38bdf8;
      --ok: #34d399;
      --warn: #f59e0b;
      --danger: #f43f5e;
      --text: #e6eef6;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #081025 0%, #071424 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif
    }

    .wrap {
      max-width: 960px;
      margin: 28px auto;
      padding: 24px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.04)
    }

    header {
      display: flex;
      gap: 16px;
      align-items: center
    }

    .logo {
      width: 56px;
      height: 56px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #04293a
    }

    h1 {
      margin: 0;
      font-size: 1.15rem
    }

    p.lead {
      margin: 6px 0 18px;
      color: var(--muted)
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      margin-top: 18px
    }

    .card {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.06)
    }

    .muted {
      color: var(--muted);
      font-size: 0.9rem
    }

    /* フォーム行：小型入力欄 */
    .form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px
    }

    .inline {
      display: flex;
      gap: 14px;
      align-items: flex-end;
      flex-wrap: wrap
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px
    }

    input {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #0a1322;
      color: var(--text);
      font-size: 0.9rem
    }

    /* ここでサイズを小さくする */
    .w-net {
      width: 140px;
      max-width: 140px
    }

    .w-host {
      width: 90px;
      max-width: 90px
    }

    /* モバイルでは全幅に */
    @media (max-width:560px) {

      .w-net,
      .w-host {
        width: 100%;
        max-width: 100%
      }
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 2px
    }

    .error {
      color: var(--danger);
      font-size: 0.85rem;
      margin-top: 4px;
      display: none
    }

    .download {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: stretch
    }

    button#dl {
      background: linear-gradient(180deg, var(--accent), #0ea5e9);
      border: none;
      color: #012;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(14, 165, 233, 0.18)
    }

    button#dl:disabled {
      filter: grayscale(.8);
      opacity: .6;
      cursor: not-allowed
    }

    .warn {
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), rgba(244, 63, 94, 0.04));
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--muted)
    }

    .notice {
      margin-top: 12px;
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.15), rgba(244, 63, 94, 0.1));
      border-left: 4px solid var(--warn);
      padding: 12px;
      border-radius: 8px
    }

    pre#code {
      background: #021124;
      color: #d7f6ff;
      padding: 12px;
      border-radius: 8px;
      overflow: auto;
      max-height: 360px;
      border: 1px dashed rgba(255, 255, 255, 0.12);
      font-size: 12.5px;
      line-height: 1.4
    }

    footer {
      margin-top: 18px;
      color: var(--muted);
      font-size: 0.85rem
    }

    @media (max-width:900px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    button#dl {
      background: linear-gradient(180deg, var(--accent), #0ea5e9);
      border: none;
      color: #012;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(56, 189, 248, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.15s ease-in-out;
    }

    button#dl:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(56, 189, 248, 0.55),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    button#dl:active {
      transform: translateY(0);
      box-shadow: 0 3px 8px rgba(56, 189, 248, 0.35);
    }

    button#dl:disabled {
      filter: grayscale(0.8);
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
  </style>

</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo">IP</div>
      <div>
        <h1>ipscan.bat — LAN内の Raspberry Pi 検出ツール</h1>
        <p class="lead">ベースネットワークと開始/終了ホスト番号を入力して、あなたのLANに合わせた <code>ipscan.bat</code> を生成します。</p>
      </div>
    </header>

    <div class="grid">
      <!-- 左カラム：設定カード -->
      <div class="card">
        <h2 style="margin-top:0">設定</h2>

        <!-- 小さな入力欄を横並びに -->
        <div class="inline">
          <div>
            <label for="netbase">NET_BASE</label>
            <input id="netbase" class="w-net" placeholder="例: 192.168.1" value="192.168.1" inputmode="numeric" />
          </div>
          <div>
            <label for="start">START</label>
            <input id="start" class="w-host" value="2" inputmode="numeric" />
          </div>
          <div>
            <label for="end">END</label>
            <input id="end" class="w-host" value="254" inputmode="numeric" />
          </div>
        </div>
        <div id="netErr" class="error" style="margin-top:6px">形式が正しくありません（例: 192.168.1）。</div>
        <div class="hint">第3オクテットまでを指定。スキャン対象は NET_BASE.START ～ NET_BASE.END。</div>

        <div class="warn" style="margin-top:12px">
          <strong>実行方法:</strong> ダウンロードした <code>ipscan.bat</code> をダブルクリックして実行します。
        </div>

        <div class="notice">
          ⚠️ <strong>注意:</strong><br>
          ・スキャンには<strong>非常に時間がかかる</strong>場合があります。環境によっては完了まで<strong>数分以上</strong>かかります。<br><br>
          ・<strong>セキュリティ警告:</strong> 実行時に Windows の警告が出る場合があります。配布元が信頼できる場合のみそのまま実行してください。
        </div>
      </div>

      <!-- 右カラム：ダウンロードカード -->
      <div class="card download">
        <div>
          <strong>ダウンロード</strong>
          <p class="muted" style="margin:6px 0 12px">入力内容で埋め込んだ <code>ipscan.bat</code> を生成します。</p>
          <button id="dl" disabled>バッチファイルをダウンロード</button>
        </div>

        <div style="margin-top:12px">
          <strong>バッチ本体（プレビュー）</strong>
          <pre id="code" aria-hidden="false"></pre>
        </div>
      </div>
    </div>

    <footer></footer>
  </div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const net = $('netbase'), start = $('start'), end = $('end'), dl = $('dl'), code = $('code'), netErr = $('netErr');

      function isOctet(n) { return /^\d+$/.test(n) && +n >= 0 && +n <= 255; }
      function isValidNetBase(s) {
        const m = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.exec(s.trim());
        return m && isOctet(m[1]) && isOctet(m[2]) && isOctet(m[3]);
      }
      function isValidRange(a, b) {
        return /^\d+$/.test(a) && /^\d+$/.test(b) && +a >= 0 && +b <= 255 && +a <= +b;
      }

      function buildBat(netBase, startHost, endHost) {
        return "\uFEFF" + `:: BOM guard
@echo off
chcp 65001 >nul
setlocal EnableDelayedExpansion

rem === ネットワーク設定 ===
set "NET_BASE=${netBase}"
set "START=${startHost}"
set "END=${endHost}"

rem 表示
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "[Console]::OutputEncoding=[System.Text.Encoding]::UTF8;" ^
  "Write-Host '===============================';" ^
  "Write-Host 'ネットワーク設定:';" ^
  "Write-Host ('  ネットワークベース:  {0}' -f $env:NET_BASE);" ^
  "Write-Host ('  開始ホスト:           {0}' -f $env:START);" ^
  "Write-Host ('  終了ホスト:           {0}' -f $env:END);" ^
  "Write-Host '===============================';" ^
  "Write-Host 'IPアドレススキャンを開始します。';" ^
  "Write-Host '⚠️ 注意';" ^
  "Write-Host 'スキャンには非常に時間がかかる場合があります。'"

echo.
echo IP              HostName                  MAC                Vendor
echo ------------------------------------------------------------------------

for /L %%i in (!START!,1,!END!) do (
  for /f %%r in ('powershell -NoProfile -Command "Test-Connection -Quiet -Count 1 %NET_BASE%.%%i"') do (
    if %%r==True (
      powershell -NoProfile -ExecutionPolicy Bypass -Command ^
        "$ip='%NET_BASE%.%%i';" ^
        "$m = arp -a $ip | Select-String -Pattern ('^\\s*' + [regex]::Escape($ip) + '\\s+([0-9A-Fa-f:-]{12,17})');" ^
        "if($m){ $mac=$m.Matches[0].Groups[1].Value } else { $mac='' };" ^
        "try{ $hn=[System.Net.Dns]::GetHostEntry($ip).HostName } catch { $hn='' };" ^
        "$vendor='';" ^
        "if($mac -match 'B8-27-EB|DC-A6-32|E4-5F-01|2C-CF-67'){ $vendor='Raspberry Pi Foundation' };" ^
        "('{0,-15} {1,-25} {2,-17} {3}' -f $ip,$hn,$mac,$vendor)"
    )
  )
)

echo.
echo スキャン完了
pause`.replace(/\r?\n/g, "\r\n");
      }

      function refresh() {
        const nb = net.value.trim(), st = start.value.trim(), ed = end.value.trim();
        const okB = isValidNetBase(nb), okR = isValidRange(st, ed);
        netErr.style.display = okB ? "none" : "block";
        dl.disabled = !(okB && okR);
        if (okB && okR) {
          const bat = buildBat(nb, st, ed);
          code.textContent = bat;
          dl.onclick = () => {
            const blob = new Blob([bat], { type: "text/plain;charset=utf-8" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "ipscan.bat";
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(() => URL.revokeObjectURL(a.href), 1e3);
          };
        } else {
          code.textContent = "// 入力が不正です。";
          dl.onclick = null;
        }
      }
      net.oninput = start.oninput = end.oninput = refresh;
      refresh();
    })();
  </script>
</body>

</html>